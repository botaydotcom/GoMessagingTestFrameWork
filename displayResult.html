<html>
<head>
  <link href="js/css/examples.css" rel="stylesheet" type="text/css">
  <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
  <script type="text/javascript" src="js/jquery.flot.js"></script>
<script>
  $(function (){

    chart = {};
    var totalPoints = 360;

    var yscale = 15000;

    function initialize() {
      var url = "/getInfo";
      xmlhttp=new XMLHttpRequest();
      xmlhttp.onreadystatechange=function()
      {
      if (xmlhttp.readyState==4 && xmlhttp.status==200)
        {
          document.getElementById("info").innerHTML=xmlhttp.responseText;
          var obj = JSON.parse(xmlhttp.responseText);           
          totalPoints = obj.duration + 60;
          yscale = obj.rate * 2.5;
        }
      }
      xmlhttp.open("GET", url, false);
      xmlhttp.send();
          
    }

    function getData(data) {

      if (data.length > totalPoints) {
        data = data.slice(data.length - totalPoints);
      }
      var res = [];
      for (var i = 0; i < data.length; ++i) {
        res.push([i, data[i]])
      }
      //console.log(res);
      return res;
    }

    function calculateAverageData(data, duration) {
      var length = data.length;
      if (length > duration) {
        return data[length - 1] - data[length - 1-duration];
      } else {
        return data[length - 1];
      }
    }

    initialize();

      var dataSeries = [
      {label:"Total Connection", data: []},
      {label:"Total Concurrent", data: []},
      {label:"Total Finished", data: []},
      {label:"Total Successful", data: []},
      {label:"Percent Correct", data: [], yaxis: 3},
      {label:"Total Request", data: [], yaxis: 4},
      {label:"Connection per minute", data: [], yaxis: 4},
      {label:"Finished per minute", data: [], yaxis: 4},
      {label:"Successful per minute", data: [], yaxis: 4},
      {label:"Requests per second", data: [], yaxis: 4},
      {label:"Average Response Time", data: [], yaxis: 2}
    ];

    var TOTAL_CONNECTION = 0;
    var CONCURRENT = 1;
    var FINISHED = 2;
    var SUCCESS = 3;
    var PERCENT = 4;
    var TOTAL_REQUEST = 5;
    var CONNECTION_PM = 6
    var FINISHED_PM = 7;
    var SUCCESS_PM = 8;
    var REQUEST_PS = 9;
    var RESPONSE = 10;

    var option = {
      legend: {
        show: true,
        position: "nw"
      },
      lines: {
          show: true
        },
      series: {
        shadowSize: 0 // Drawing is faster without shadows
      },
      yaxes: [ 
      {
        min: 0,
        max: yscale,
        show: true
      }, 
      { 
        position: "right", 
        min: 0,
        max: 500,
        show: true } ,
      {
        min: 0,
        max: 105,
        show: true
      },
      {
        min: 0,
        max: yscale,
        show: true
      } 
      ], 

      xaxis: {
        min: 0,
        max: totalPoints,
        show: true
      }
    };

    var plot = $.plot("#placeholder", dataSeries, option);

    function getSeriesObject(name, data, axis) {
      if (typeof axis != "undefined") {
        return {label: name, data: data, yaxis: axis};
      } else {
        return {label: name, data: data}; 
      }
    }

    

     function updateChart(newData) {
        var obj = JSON.parse(newData);
        dataSeries[TOTAL_CONNECTION].data.push(obj["TotalConnection"]);
        dataSeries[CONCURRENT].data.push(obj["TotalAliveConnection"]);
        dataSeries[FINISHED].data.push(obj["TotalFinished"]);
        dataSeries[SUCCESS].data.push(obj["TotalSuccessful"]);
        dataSeries[PERCENT].data.push(obj["PercentCorrect"]);
        dataSeries[TOTAL_REQUEST].data.push(obj["NumRealTimeRequest"]);
        dataSeries[CONNECTION_PM].data.push(calculateAverageData(dataSeries[TOTAL_CONNECTION].data, 60));
        dataSeries[REQUEST_PS].data.push(calculateAverageData(dataSeries[TOTAL_REQUEST].data, 60) / 60);
        dataSeries[FINISHED_PM].data.push(calculateAverageData(dataSeries[FINISHED].data, 60));
        dataSeries[SUCCESS_PM].data.push(calculateAverageData(dataSeries[SUCCESS].data, 60));

        dataSeries[RESPONSE].data.push(obj["AverageResponse"])
        data = [];
        for (var i = 0; i < dataSeries.length; i++) {
          dataValue = [];
          if (document.getElementById("cb" + i).checked) {
            dataValue = getData(dataSeries[i].data);
            data.push(getSeriesObject(dataSeries[i].label, dataValue, dataSeries[i].yaxis));
          }          
        }
        plot.setData(data);

          // Since the axes don't change, we don't need to call plot.setupGrid()

        plot.draw();
        var keys = Object.keys(obj.ErrorList);
        message = "";
        for (var i = 0; i < keys.length; i++) {
          var key = keys[i];
          message = "<p>" + message + "OCCUR " + obj.ErrorList[key] + " - " + key + "</p>";
        }
        document.getElementById("errors").innerHTML=message;
    }

    function replot() {
      for (var i = 0; i < dataSeries.length; i++) {
        data = [];
        for (var i = 0; i < dataSeries.length; i++) {
          dataValue = [];
          if (document.getElementById("cb" + i).checked) {
            dataValue = getData(dataSeries[i].data);
            data.push(getSeriesObject(dataSeries[i].label, dataValue, dataSeries[i].yaxis));
          }
        }
        plot = $.plot("#placeholder", data, option);   
      }
    }

    for (var i = 0; i < dataSeries.length; i++) {
      var id = "#cb" + i;
      $(id).click(replot);
    }
    
    w=new Worker("js/drawchart.js");
    w.onmessage = function(event) {
      console.log("GETTING DATA NOW");
      document.getElementById("result").innerHTML=event.data;
      updateChart(event.data);
    };

    $("#resetButton").click(function(event) {
      for (var i = 0; i < dataSeries.length; i++) {
        dataSeries[i].data = [];
      }
      replot();
    });
  });
</script>
</head>
<body>
  <div id="header">
    <h3>Real-time updates</h2>
    <p> Parameters: 
    <div id="info"></div>
    <input type="button" value="Reset" id="resetButton"/>
    </p>
    <form id="form1">
      <input type="checkbox" id="cb0" checked="true">Total Connection
      <input type="checkbox" id="cb1" checked="true">Total Concurrent
      <input type="checkbox" id="cb2" checked="true">Total Finished
      <input type="checkbox" id="cb3" checked="true">Total Successful    
      <input type="checkbox" id="cb5" checked="true">Total Request
      <p></p>
      <input type="checkbox" id="cb6" checked="true">Connection per minute
      <input type="checkbox" id="cb7" checked="true">Finished per minute
      <input type="checkbox" id="cb8" checked="true">Successful per minute
      <input type="checkbox" id="cb9" checked="true">Requests per second
      <p></p>
      <input type="checkbox" id="cb4" checked="true">Percent Correct
      <input type="checkbox" id="cb10" checked="true">Average Response Time
    </form>
  </div>

  <div id="content">
    <div class="demo-container">
      <div id="placeholder" class="demo-placeholder"></div>
    </div>
  </div>  
  <div id="errors"></div>
  <div id="result"></div>
</body>
</html>